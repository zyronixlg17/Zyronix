<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Zyronix-LG - Endosador Autom√°tico</title>
    <link rel="icon" href="icono.png">
    <link rel="stylesheet" href="endosadorautomatico.css">
</head>

<body>

<h2>Sube uno o m√°s archivos PDF para endosar</h2>

<div id="Controles">

    <label>
        <input type="checkbox" id="selloEnvases">
        <span></span>
        Sello Envases Universales
    </label>

    <label>
        <input type="checkbox" id="selloAltaCargo" checked>
        <span></span>
        Sello AltaCargo Manzanillo
    </label>

    <label>
        <input type="checkbox" id="selloVeracruz">
        <span></span>
        Sello Altacargo Veracruz
    </label>

    <label>
        <input type="checkbox" id="selloVeronica">
        <span></span>
        Sello Altacargo Ver√≥nica Altamira
    </label>

</div>

<input type="file" id="pdfUploader" accept="application/pdf" multiple>

<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<script>
const uploader = document.getElementById("pdfUploader");

const chkEnvases   = document.getElementById("selloEnvases");
const chkAltaCargo = document.getElementById("selloAltaCargo");
const chkVeracruz  = document.getElementById("selloVeracruz");
const chkVeronica  = document.getElementById("selloVeronica");

const terminales = [chkAltaCargo, chkVeracruz, chkVeronica];

terminales.forEach(chk => {
    chk.addEventListener("change", () => {
        if (chk.checked) {
            terminales.forEach(o => {
                if (o !== chk) o.checked = false;
            });
        }
    });
});

async function cargarSello(pdfDoc, url) {
    const res = await fetch(url);
    if (!res.ok) {
        console.error("‚ùå No se encontr√≥ el sello:", url);
        throw new Error("No se pudo cargar el sello: " + url);
    }
    const bytes = await res.arrayBuffer();
    return pdfDoc.embedPng(bytes);
}

uploader.addEventListener("change", async (e) => {

    for (const file of e.target.files) {

        const reader = new FileReader();

        reader.onload = async ev => {
            try {

                let pdfDoc;
                try {
                    pdfDoc = await PDFLib.PDFDocument.load(ev.target.result);
                } catch {
                    alert(
                        "‚ö†Ô∏è DOCUMENTO PROTEGIDO\n\n" +
                        "Este PDF est√° encriptado y no puede ser endosado."
                    );
                    return;
                }

                const pages = pdfDoc.getPages();

                let selloEnvasesImg = null;
                let selloTerminalImg = null;

                if (chkEnvases.checked) {
                    selloEnvasesImg = await cargarSello(pdfDoc, "selloenvases.png");
                }

                if (chkAltaCargo.checked) {
                    selloTerminalImg = await cargarSello(pdfDoc, "selloaltacargo.png");
                } 
                else if (chkVeracruz.checked) {
                    selloTerminalImg = await cargarSello(pdfDoc, "selloaltacargoveracruz1.png");
                } 
                else if (chkVeronica.checked) {
                    selloTerminalImg = await cargarSello(pdfDoc, "selloaltacargoveronica2.png");
                }

                if (!selloTerminalImg) {
                    alert("‚ö†Ô∏è Selecciona un sello de terminal.");
                    return;
                }

                const W_ENVASES  = 220;
                const W_TERMINAL = 200;

                pages.forEach(page => {
                    const { width, height } = page.getSize();

                    if (selloEnvasesImg) {
                        const h = (selloEnvasesImg.height / selloEnvasesImg.width) * W_ENVASES;
                        page.drawImage(selloEnvasesImg, {
                            x: 10,
                            y: height - h - 450,
                            width: W_ENVASES,
                            height: h
                        });
                    }

                    const hT = (selloTerminalImg.height / selloTerminalImg.width) * W_TERMINAL;
                    page.drawImage(selloTerminalImg, {
                        x: width - W_TERMINAL - 10,
                        y: height - hT - 430,
                        width: W_TERMINAL,
                        height: hT
                    });
                });

                const pdfBytes = await pdfDoc.save();

                const blob = new Blob([pdfBytes], { type: "application/pdf" });
                const url = URL.createObjectURL(blob);

                const limpio = file.name
                    .replace(".pdf", "")
                    .replace(/[^a-zA-Z0-9]/g, "");

                const link = document.createElement("a");
                link.href = url;
                link.download = `ENDOSADO-${limpio}.pdf`;
                link.click();

                URL.revokeObjectURL(url);

            } catch (err) {
                alert("‚ùå Error:\n" + err.message);
            }
        };

        reader.readAsArrayBuffer(file);
    }

    uploader.value = "";
});
</script>

<div class="footer">
    Endoso autom√°tico creado por <span>Zyronix-LG</span> üå¨Ô∏èüçÉ
</div>

</body>
</html>
